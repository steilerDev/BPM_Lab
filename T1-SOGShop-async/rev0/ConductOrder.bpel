<!-- ConductOrder BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Sat Dec 03 22:37:03 CET 2016 -->
<bpel:process name="ConductOrder"
              targetNamespace="http://group-one"
              suppressJoinFailure="yes"
              xmlns:tns="http://group-one"
              xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
              xmlns:ns="http://iaas.uni-stuttgart.de/labs/FlowSOG">

    <!-- Import the client WSDL -->
    <bpel:import namespace="http://iaas.uni-stuttgart.de/labs/FlowSOG"
                 location="bpm-lab.wsdl" 
                 importType="http://schemas.xmlsoap.org/wsdl/" />

	<bpel:import namespace="http://group-one"
	             location="ConductOrderArtifacts.wsdl"  
	             importType="http://schemas.xmlsoap.org/wsdl/" />
         
    <!-- ================================================================= -->         
    <!-- PARTNERLINKS                                                      -->
    <!-- List of services participating in this BPEL process               -->
    <!-- ================================================================= -->         
    <bpel:partnerLinks>
        <!-- The 'client' role represents the requester of this service. -->
        <bpel:partnerLink name="client"
                          partnerLinkType="tns:ConductOrder"
                          myRole="ConductOrderProvider" />
                          
        <bpel:partnerLink name="InventoryServicePL" 
                          partnerLinkType="tns:InventoryServicePLT" 
                          partnerRole="InventoryServicePLRole" />
                         
        <bpel:partnerLink name="OrderServicePL" 
                          partnerLinkType="tns:OrderServicePLT" 
                          partnerRole="OrderServicePLRole"/>
                          
        <bpel:partnerLink name="ShipmentServicePL" 
                          partnerLinkType="tns:ShipmentServicePLT" 
                          partnerRole="ShipmentServicePLRole"/>
                       
        <bpel:partnerLink name="PaymentServicePL" 
                          partnerLinkType="tns:PaymentServicePLT" 
                          partnerRole="PaymentServicePLRole"/>
                          
        <bpel:partnerLink name="InventoryCallbackPL" 
                          partnerLinkType="tns:InventoryCallbackPLT" 
                          myRole="InventoryCallbackPLRole"/>
    </bpel:partnerLinks>
  
    <!-- ================================================================= -->         
    <!-- VARIABLES                                                         -->
    <!-- List of messages and XML documents used within this BPEL process  -->
    <!-- ================================================================= -->         
    <bpel:variables>
        <!-- Reference to the message passed as input during initiation -->
        <bpel:variable name="input"
                       messageType="tns:ConductOrderRequestMessage"/>
                  
        <!-- 
          Reference to the message that will be returned to the requester
          -->
        <bpel:variable name="output"
                       messageType="tns:ConductOrderResponseMessage"/>
                       
        <bpel:variable name="InventoryServicePLCheckAvailabilityResponse" 
                       messageType="ns:checkAvailabilityOutput"/>
        <bpel:variable name="InventoryServicePLCheckAvailabilityRequest" 
                       messageType="ns:checkAvailabilityInput"/>
                       
        <bpel:variable name="OrderServicePLStoreOrderResponse" 
                       messageType="ns:storeOrderDetailsOutput"/>
        <bpel:variable name="OrderServicePLStoreOrderRequest" 
                       messageType="ns:storeOrderDetailsInput"/>
        <bpel:variable name="OrderServicePLCalcOrderCostsResponse" 
                       messageType="ns:calcOrderCostsOutput"/>
        <bpel:variable name="OrderServicePLCalcOrderCostsRequest" 
                       messageType="ns:calcOrderCostsInput"/>
        <bpel:variable name="OrderServicePLCancelOrderRequest" 
                       messageType="ns:cancelOrderInput"/>
                       
        <bpel:variable name="ShipmentServicePLCalcShipmentCostsResponse" 
                       messageType="ns:calcShipmentCostsOutput"/>
        <bpel:variable name="ShipmentServicePLCalcShipmentCostsRequest" 
                       messageType="ns:calcShipmentCostsInput"/>
                       
        <bpel:variable name="PaymentServicePLCalcTransactionCostsResponse" 
                       messageType="ns:calcTransactionCostsOutput"/>
        <bpel:variable name="PaymentServicePLCalcTransactionCostsRequest" 
                       messageType="ns:calcTransactionCostsInput"/>
        <bpel:variable name="PaymentServicePLConductPaymentResponse" 
                       messageType="ns:conductPaymentOutput"/>
        <bpel:variable name="PaymentServicePLConductPaymentRequest" 
                       messageType="ns:conductPaymentInput"/>
        <bpel:variable name="ShipmentServicePLShipProductsResponse" 
                       messageType="ns:shipProductsOutput"/>
        <bpel:variable name="ShipmentServicePLShipProductsRequest" 
                       messageType="ns:shipProductsInput"/>
    </bpel:variables>

    <!-- ================================================================= -->         
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->         
    <bpel:sequence name="main">
        
        <!-- Receive input from requester. 
             Note: This maps to operation defined in ConductOrder.wsdl 
             -->
        <bpel:receive name="receiveInput" partnerLink="client"
                 portType="tns:ConductOrder"
                 operation="process" 
                 variable="input"
                 createInstance="yes"/>

        <bpel:assign validate="no" name="AssignOrder">
            <bpel:copy>
                <bpel:from>
                    <bpel:literal>
                        <tns:storeOrderDetails xmlns:tns="http://iaas.uni-stuttgart.de/labs/FlowSOG" 
                                               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                            <tns:customerId>tns:customerId</tns:customerId>
                            <tns:products>
                                <tns:product>
                                    <tns:productId>tns:productId</tns:productId>
                                    <tns:numberOfItems>0</tns:numberOfItems>
                                </tns:product>
                            </tns:products>
                            <tns:shippingAddress>tns:shippingAddress</tns:shippingAddress>
                            <tns:paymentDetails>
                                <tns:bankName>tns:bankName</tns:bankName>
                                <tns:bankAddress>tns:bankAddress</tns:bankAddress>
                                <tns:accountNumber>tns:accountNumber</tns:accountNumber>
                                <tns:accountHolderName>tns:accountHolderName</tns:accountHolderName>
                            </tns:paymentDetails>
                        </tns:storeOrderDetails>
                    </bpel:literal>
                </bpel:from>
                <bpel:to variable="OrderServicePLStoreOrderRequest" part="storeOrderDetailsInput" />
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:input/tns:customerId]]>
                    </bpel:query>
                </bpel:from>
                <bpel:to part="storeOrderDetailsInput" variable="OrderServicePLStoreOrderRequest">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns:customerId]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:input/tns:products]]>
                    </bpel:query>
                </bpel:from>
                <bpel:to part="storeOrderDetailsInput" variable="OrderServicePLStoreOrderRequest">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns:products]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:input/tns:shippingAddress]]>
                    </bpel:query>
                </bpel:from>
                <bpel:to part="storeOrderDetailsInput" variable="OrderServicePLStoreOrderRequest">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns:shippingAddress]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:input/tns:paymentDetails]]>
                    </bpel:query>
                </bpel:from>
                <bpel:to part="storeOrderDetailsInput" variable="OrderServicePLStoreOrderRequest">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns:paymentDetails]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
        </bpel:assign>
        
        <bpel:invoke name="InvokeStoreOrder" 
                     partnerLink="OrderServicePL" 
                     operation="storeOrderDetails" 
                     portType="ns:OrderPortType" 
                     inputVariable="OrderServicePLStoreOrderRequest" 
                     outputVariable="OrderServicePLStoreOrderResponse" />
                     
        <bpel:flow name="MainFlow">
            <bpel:scope name="OrderProcessingScope">
                <bpel:sequence name="OrderProcessingSequence">
	                <bpel:assign validate="no" name="AssignOrderIdToCalcCosts">
	                    <!-- ############################################### -->
	                    <!-- Calculate order costs                           -->
	                    <!-- ############################################### -->
	                    <bpel:copy>
	                        <bpel:from>
	                            <bpel:literal xml:space="preserve">
	                                <tns:calcOrderCosts xmlns:tns="http://iaas.uni-stuttgart.de/labs/FlowSOG" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
	                                    <tns:orderId>tns:orderId</tns:orderId>
	                                </tns:calcOrderCosts></bpel:literal>
	                        </bpel:from>
	                        <bpel:to variable="OrderServicePLCalcOrderCostsRequest" part="calcOrderCostsInput" />
	                    </bpel:copy>
	                    <bpel:copy>
	                        <bpel:from part="storeOrderDetailsOutput" variable="OrderServicePLStoreOrderResponse">
	                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
	                                <![CDATA[ns:orderId]]>
	                            </bpel:query>
	                        </bpel:from>
	                        <bpel:to part="calcOrderCostsInput" variable="OrderServicePLCalcOrderCostsRequest">
	                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
	                                <![CDATA[ns:orderId]]>
	                            </bpel:query>
	                        </bpel:to>
	                    </bpel:copy>
	                    <!-- ############################################### -->
	                    <!-- Calculate shipment costs                        -->
	                    <!-- ############################################### -->
	                    <bpel:copy>
	                        <bpel:from>
	                            <bpel:literal>
	                                <tns:calcShipmentCosts xmlns:tns="http://iaas.uni-stuttgart.de/labs/FlowSOG" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
	                                    <tns:orderId>tns:orderId</tns:orderId>
	                                </tns:calcShipmentCosts>
	                            </bpel:literal>
	                        </bpel:from>
	                        <bpel:to variable="ShipmentServicePLCalcShipmentCostsRequest" part="calcShipmentCostsInput"></bpel:to>
	                    </bpel:copy>
	                    <bpel:copy>
	                        <bpel:from part="storeOrderDetailsOutput" variable="OrderServicePLStoreOrderResponse">
	                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:orderId]]></bpel:query>
	                        </bpel:from>
	                        <bpel:to part="calcShipmentCostsInput" variable="ShipmentServicePLCalcShipmentCostsRequest">
	                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:orderId]]></bpel:query>
	                        </bpel:to>
	                    </bpel:copy>
	                    <!-- ############################################### -->
	                    <!-- Calculate transaction costs                     -->
	                    <!-- ############################################### -->
	                    <bpel:copy>
	                        <bpel:from>
	                            <bpel:literal>
	                                <tns:calcTransactionCosts xmlns:tns="http://iaas.uni-stuttgart.de/labs/FlowSOG" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
	                                    <tns:orderId>tns:orderId</tns:orderId>
	                                </tns:calcTransactionCosts>
	                            </bpel:literal>
	                        </bpel:from>
	                        <bpel:to variable="PaymentServicePLCalcTransactionCostsRequest" part="calcTransactionCostsInput" />
	                    </bpel:copy>
	                    <bpel:copy>
	                        <bpel:from part="storeOrderDetailsOutput" variable="OrderServicePLStoreOrderResponse">
	                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
	                                <![CDATA[ns:orderId]]>
	                            </bpel:query>
	                        </bpel:from>
	                        <bpel:to part="calcTransactionCostsInput" variable="PaymentServicePLCalcTransactionCostsRequest">
	                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
	                                <![CDATA[ns:orderId]]>
	                            </bpel:query>
	                        </bpel:to>
	                    </bpel:copy>
	                </bpel:assign>
                
	                <bpel:flow name="CalcCostsFlow">
	                    <bpel:invoke name="InvokeCalcOrderCosts" 
	                                 partnerLink="OrderServicePL" 
	                                 operation="calcOrderCosts" 
	                                 portType="ns:OrderPortType" 
	                                 inputVariable="OrderServicePLCalcOrderCostsRequest" 
	                                 outputVariable="OrderServicePLCalcOrderCostsResponse" />
	                                 
	                    <bpel:invoke name="InvokeCalcShipmentCosts" 
	                                 partnerLink="ShipmentServicePL" 
	                                 operation="calcShipmentCosts" 
	                                 portType="ns:ShipmentPortType" 
	                                 inputVariable="ShipmentServicePLCalcShipmentCostsRequest" 
	                                 outputVariable="ShipmentServicePLCalcShipmentCostsResponse" />
	                                 
	                    <bpel:invoke name="InvokeCalcTransactionCosts" 
	                                 partnerLink="PaymentServicePL" 
	                                 operation="calcTransactionCosts" 
	                                 portType="ns:PaymentPortType" 
	                                 inputVariable="PaymentServicePLCalcTransactionCostsRequest" 
	                                 outputVariable="PaymentServicePLCalcTransactionCostsResponse" />
	                </bpel:flow>
	                     
	                <bpel:assign validate="no" name="AssignTotalCostsAndOrderIdToConductPayment">
	                    <bpel:copy>
	                        <bpel:from>
	                            <bpel:literal>
	                                <tns:conductPayment xmlns:tns="http://iaas.uni-stuttgart.de/labs/FlowSOG" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
	                                    <tns:orderId>tns:orderId</tns:orderId>
	                                    <tns:amount>0.0</tns:amount>
	                                </tns:conductPayment>
	                            </bpel:literal>
	                        </bpel:from>
	                        <bpel:to variable="PaymentServicePLConductPaymentRequest" part="conductPaymentInput" />
	                    </bpel:copy>
	                    <bpel:copy>
	                        <bpel:from>
	                            $PaymentServicePLCalcTransactionCostsResponse.calcTransactionCostsOutput/ns:transactionCosts +
	                            $ShipmentServicePLCalcShipmentCostsResponse.calcShipmentCostsOutput/ns:shipmentCosts +
	                            $OrderServicePLCalcOrderCostsResponse.calcOrderCostsOutput/ns:orderCosts
	                        </bpel:from>
	                        <bpel:to part="conductPaymentInput" variable="PaymentServicePLConductPaymentRequest">
	                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:amount]]></bpel:query>
	                        </bpel:to>
	                    </bpel:copy>
	                    <bpel:copy>
	                        <bpel:from part="storeOrderDetailsOutput" variable="OrderServicePLStoreOrderResponse">
	                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:orderId]]></bpel:query>
	                        </bpel:from>
	                        <bpel:to part="conductPaymentInput" variable="PaymentServicePLConductPaymentRequest">
	                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:orderId]]></bpel:query>
	                        </bpel:to>
	                    </bpel:copy>
	                </bpel:assign>
	            </bpel:sequence>
            </bpel:scope>
            
            <bpel:scope name="CheckAvailabilityScope">
                <bpel:sequence name="CheckAvailabilitySequence">
                    <bpel:forEach parallel="yes" counterName="index" name="ForEachProduct"><bpel:startCounterValue>
			                <![CDATA[1]]>
			            </bpel:startCounterValue>
			            <bpel:finalCounterValue>
			                <![CDATA[count($input.payload/tns:input/tns:products/tns:product)]]>
			            </bpel:finalCounterValue>
            
                        <bpel:scope name="CreateProductListScope">
			                <bpel:if name="IfProductQtyGreaterZero">
			                    <bpel:condition>
			                        <![CDATA[$input.payload/tns:input/tns:products/tns:product[round($index)]/tns:numberOfItems > 0]]>
			                    </bpel:condition>
			                    <bpel:sequence name="CreateProductListSequence">
			                        <bpel:assign validate="no" name="AssignProductIDToCheckAvailability">
                                        <bpel:copy>
                                            <bpel:from>
                                                <bpel:literal>
                                                    <FlowSOG:checkAvailability xmlns:FlowSOG="http://iaas.uni-stuttgart.de/labs/FlowSOG" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                                                        <FlowSOG:productId>FlowSOG:productId</FlowSOG:productId>
                                                    </FlowSOG:checkAvailability>
                                                </bpel:literal>
                                            </bpel:from>
                                            <bpel:to part="checkAvailabilityInput" variable="InventoryServicePLCheckAvailabilityRequest" />
                                        </bpel:copy>
                                        <bpel:copy>
                                            <bpel:from part="payload" variable="input">
                                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                    <![CDATA[tns:input/tns:products/tns:product[round($index)]/tns:productId]]>
                                                </bpel:query>
                                            </bpel:from>
                                            <bpel:to part="checkAvailabilityInput" variable="InventoryServicePLCheckAvailabilityRequest">
                                                <bpel:query>
                                                    <![CDATA[ns:productId]]>
                                                </bpel:query>
                                            </bpel:to>
                                        </bpel:copy>
                                    </bpel:assign>
			                    </bpel:sequence>
			                </bpel:if>  
                        </bpel:scope>
                    </bpel:forEach>
                    <bpel:invoke name="InvokeCheckAvailability" 
                                 partnerLink="InventoryServicePL" 
                                 operation="checkAvailabilityAsync" 
                                 portType="ns:InventoryPortType" 
                                 inputVariable="InventoryServicePLRequest"/>
                </bpel:sequence>
            </bpel:scope>
        </bpel:flow>
          
        <bpel:scope name="PaymentScope">
            <bpel:sequence name="PaymentSequence">
                <bpel:if name="IfProductNotAvailable">
                    <bpel:condition>
                        <![CDATA[$InventoryServicePLCheckAvailabilityResponse.checkAvailabilityOutput/ns:product/ns:status/ns:currentAvailability = "not available"]]>
                    </bpel:condition>
                    <bpel:throw name="ThrowProductNotAvailableFault" faultName="tns:ProductNotAvailableFault" />    
                </bpel:if>
                
                <bpel:invoke name="InvokeConductPayment" 
                             partnerLink="PaymentServicePL" 
                             operation="conductPayment" 
                             portType="ns:PaymentPortType" 
                             inputVariable="PaymentServicePLConductPaymentRequest" 
                             outputVariable="PaymentServicePLConductPaymentResponse" />
                             
                <bpel:if name="IfPaymentUnsuccesful">
                    <bpel:condition>
                        <![CDATA[$PaymentServicePLConductPaymentResponse.conductPaymentOutput/ns:status != "payed"]]>
                    </bpel:condition>
                    <bpel:throw name="ThrowPaymentUnsuccesfulFault" faultName="tns:PaymentUnsuccesfulFault" />
                </bpel:if>
            </bpel:sequence>
            <bpel:faultHandlers>
                <bpel:catchAll>
                    <bpel:sequence>
                        <bpel:assign validate="no" name="AssignOrderIdToCancelOrder">
                            <bpel:copy>
                                <bpel:from>
                                    <bpel:literal>
                                        <tns:cancelOrder xmlns:tns="http://iaas.uni-stuttgart.de/labs/FlowSOG" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                                            <tns:orderId>tns:orderId</tns:orderId>
                                        </tns:cancelOrder>
                                    </bpel:literal>
                                </bpel:from>
                                <bpel:to variable="InventoryServicePLCheckAvailabilityRequest"/>
                            </bpel:copy>
                            <bpel:copy>
                                <bpel:from part="storeOrderDetailsOutput" variable="OrderServicePLStoreOrderResponse">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[ns:orderId]]>
                                    </bpel:query>
                                </bpel:from>
                                <bpel:to part="cancelOrderInput" variable="OrderServicePLCancelOrderRequest">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[ns:orderId]]>
                                    </bpel:query>
                                </bpel:to>
                            </bpel:copy>
                        </bpel:assign>
                        <bpel:invoke name="InvokeCancelOrder" 
                                     partnerLink="OrderServicePL" 
                                     operation="cancelOrder" 
                                     portType="ns:OrderPortType" 
                                     inputVariable="OrderServicePLCancelOrderRequest" />
                    
                        <bpel:assign validate="no" name="AssignProcessingError">
                            <bpel:copy>
                                <bpel:from>
                                    <bpel:literal xml:space="preserve">
                                        <tns:ConductOrderResponse xmlns:tns="http://group-one" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                                            <tns:result>Unable to process order/payment!</tns:result>
                                            <tns:order>
                                                <tns:orderId>tns:orderId</tns:orderId>
                                                <tns:customerId>tns:customerId</tns:customerId>
                                                <tns:products>
                                                    <tns:product>
                                                        <tns:productId>tns:productId</tns:productId>
                                                        <tns:numberOfItems>0</tns:numberOfItems>
                                                    </tns:product>
                                                </tns:products>
                                                <tns:shippingAddress>tns:shippingAddress</tns:shippingAddress>
                                                <tns:paymentDetails>
                                                    <tns:bankName>tns:bankName</tns:bankName>
                                                    <tns:bankAddress>tns:bankAddress</tns:bankAddress>
                                                    <tns:accountNumber>tns:accountNumber</tns:accountNumber>
                                                    <tns:accountHolderName>tns:accountHolderName</tns:accountHolderName>
                                                </tns:paymentDetails>
                                                <tns:shipmentDate>2001-01-01</tns:shipmentDate>
                                            </tns:order>
                                        </tns:ConductOrderResponse>
                                    </bpel:literal>
                                </bpel:from>
                                <bpel:to variable="output" part="payload" />
                            </bpel:copy>
                            <bpel:copy>
                                <bpel:from part="payload" variable="input">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[tns:input]]>
                                    </bpel:query>
                                </bpel:from>
                                <bpel:to part="payload" variable="output">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[tns:order]]>
                                    </bpel:query>
                                </bpel:to>
                            </bpel:copy>
                            <bpel:copy>
                                <bpel:from part="storeOrderDetailsOutput" variable="OrderServicePLStoreOrderResponse">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[ns:orderId]]>
                                    </bpel:query>
                                </bpel:from>
                                <bpel:to part="payload" variable="output">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[tns:order/tns:orderId]]>
                                    </bpel:query>
                                </bpel:to>
                            </bpel:copy>
                        </bpel:assign>
                        
                        <bpel:reply name="ReplyOutput" 
                                    partnerLink="client" 
                                    operation="process" 
                                    portType="tns:ConductOrder" 
                                    variable="output" />
                                        
                        <bpel:exit name="OrderProcessingErrorStop" />
                    
                    </bpel:sequence>
                </bpel:catchAll>
            </bpel:faultHandlers>
        </bpel:scope>
        
        <bpel:assign validate="no" name="AssignOrderIdAndOrderDateToShipProducts">
            <bpel:copy>
                <bpel:from>
                    <bpel:literal>
                        <tns:shipProducts xmlns:tns="http://iaas.uni-stuttgart.de/labs/FlowSOG" 
                                          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                            <tns:orderId>tns:orderId</tns:orderId>
                            <tns:date>2001-01-01</tns:date>
                        </tns:shipProducts>
                    </bpel:literal>
                </bpel:from>
                <bpel:to variable="ShipmentServicePLShipProductsRequest" part="shipProductsInput"/>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="storeOrderDetailsOutput" variable="OrderServicePLStoreOrderResponse">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns:orderId]]>
                    </bpel:query>
                </bpel:from>
                <bpel:to part="shipProductsInput" variable="ShipmentServicePLShipProductsRequest">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns:orderId]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:input/tns:shipmentDate]]>
                    </bpel:query>
                </bpel:from>
                <bpel:to part="shipProductsInput" variable="ShipmentServicePLShipProductsRequest">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns:date]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
        </bpel:assign>
        
        <bpel:invoke name="InvokeShipProducts" 
                     partnerLink="ShipmentServicePL" 
                     operation="shipProducts" 
                     portType="ns:ShipmentPortType" 
                     inputVariable="ShipmentServicePLShipProductsRequest" 
                     outputVariable="ShipmentServicePLShipProductsResponse"/>
                    
        <bpel:assign validate="no" name="AssignOrderSummary">
            <bpel:copy>
                <bpel:from>
                    <bpel:literal xml:space="preserve">
                        <tns:ConductOrderResponse xmlns:tns="http://group-one" 
                                                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                            <tns:result>Successfully processed order, see summary below.</tns:result>
                            <tns:order>
                                <tns:orderId>tns:orderId</tns:orderId>
                                <tns:customerId>tns:customerId</tns:customerId>
                                <tns:products>
                                    <tns:product>
                                        <tns:productId>tns:productId</tns:productId>
                                        <tns:numberOfItems>0</tns:numberOfItems>
                                    </tns:product>
                                </tns:products>
                                <tns:shippingAddress>tns:shippingAddress</tns:shippingAddress>
                                <tns:paymentDetails>
                                    <tns:bankName>tns:bankName</tns:bankName>
                                    <tns:bankAddress>tns:bankAddress</tns:bankAddress>
                                    <tns:accountNumber>tns:accountNumber</tns:accountNumber>
                                    <tns:accountHolderName>tns:accountHolderName</tns:accountHolderName>
                                </tns:paymentDetails>
                                <tns:shipmentDate>2001-01-01</tns:shipmentDate>
                                <tns:status>unknown</tns:status>
                            </tns:order>
                        </tns:ConductOrderResponse>
                    </bpel:literal>
                </bpel:from>
                <bpel:to variable="output" part="payload"/>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="shipProductsOutput" variable="ShipmentServicePLShipProductsResponse">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns:orderId]]>
                    </bpel:query>
                </bpel:from>
                <bpel:to part="payload" variable="output">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:order/tns:orderId]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="shipProductsOutput" variable="ShipmentServicePLShipProductsResponse">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns:customerId]]>
                    </bpel:query>
                </bpel:from>
                <bpel:to part="payload" variable="output">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:order/tns:customerId]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="shipProductsOutput" variable="ShipmentServicePLShipProductsResponse">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns:products]]>
                    </bpel:query>
                </bpel:from>
                <bpel:to part="payload" variable="output">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:order/tns:products]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="shipProductsOutput" variable="ShipmentServicePLShipProductsResponse">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns:shippingAddress]]>
                    </bpel:query>
                </bpel:from>
                <bpel:to part="payload" variable="output">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:order/tns:shippingAddress]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="shipProductsOutput" variable="ShipmentServicePLShipProductsResponse">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns:paymentDetails]]>
                    </bpel:query>
                </bpel:from>
                <bpel:to part="payload" variable="output">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:order/tns:paymentDetails]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="shipProductsInput" variable="ShipmentServicePLShipProductsRequest">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns:date]]>
                    </bpel:query>
                </bpel:from>
                <bpel:to part="payload" variable="output">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:order/tns:shipmentDate]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="shipProductsOutput" variable="ShipmentServicePLShipProductsResponse">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[ns:status]]>
                    </bpel:query>
                </bpel:from>
                <bpel:to part="payload" variable="output">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:order/tns:status]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
        </bpel:assign>
       
        <bpel:reply name="ReplyOutput" 
               partnerLink="client"
               portType="tns:ConductOrder"
               operation="process" 
               variable="output" />
    </bpel:sequence>
</bpel:process>

